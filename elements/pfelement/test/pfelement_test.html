<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="/components/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script src="/components/web-component-tester/browser.js"></script>
</head>

<body>

  <pfelement>
    This is the element content.
  </pfelement>

  <script type="module">
    import PFElement from "../dist/pfelement.js";

      const colors = ["red", "yellow", "blue"];

      class TestElement extends PFElement {
        static get tag() {
          return "test-element"
        }

        get html() {
          return `
            <style>:host{--context:dark;}</style>
            <div>Test Element</div>
          `;
        }

        constructor() {
          super(TestElement, { type: PFElement.PfeTypes.Content });
        }
      }

      PFElement.create(TestElement);

      class TestElementDelayRender extends PFElement {
        static get tag() {
          return "test-element-delay-render";
        }

        get html() {
          return `
            ${this.colors.map(color => `
              <div>${color}</div>
            `).join("")}
          `;
        }

        constructor() {
          super(TestElementDelayRender, { delayRender: true });
        }

        connectedCallback() {
          super.connectedCallback();

          setTimeout(() => {
            this.colors = colors;
            this.render();
          }, 0);
        }
      }

      PFElement.create(TestElementDelayRender);

      class TestChildElement extends PFElement {
        static get tag() {
          return "test-child-element"
        }

        get html() {
          return `
            <div>Test Child Element</div>
          `;
        }

        constructor() {
          super(TestChildElement, { type: PFElement.PfeTypes.Content });
        }
      }

      PFElement.create(TestChildElement);

      suite('<pfelement>', () => {
        test("it should set the pfe-g-type attribute if passed a type in the constructor", () => {
          const testElementEl = document.createElement("test-element");
          testElementEl.id = "test-element";
          document.body.appendChild(testElementEl);

          const testElement = document.querySelector("test-element");
          assert.isTrue(testElement.hasAttribute("pfe-g-type"));
          assert.equal(testElement.getAttribute("pfe-g-type"), PFElement.PfeTypes.Content);

          document.body.removeChild(testElementEl);
        });

        test("it should append the template to the shadow root in the constructor", () => {
          const testElementEl = document.createElement("test-element");
          testElementEl.id = "test-element";
          document.body.appendChild(testElementEl);

          const testElementDelayRenderEl = document.createElement("test-element-delay-render");
          testElementDelayRenderEl.id = "test-element-delay-render";
          document.body.appendChild(testElementDelayRenderEl);

          const testElement = document.querySelector("test-element");
          const testElementContent = testElement.shadowRoot.querySelector("div");

          assert.equal(testElementContent.textContent, "Test Element");

          const testElementDelayRender = document.querySelector("test-element-delay-render");
          const testElementDelayRenderShadowRoot = testElementDelayRender.shadowRoot;

          assert.isNull(testElementDelayRenderShadowRoot.querySelector("div"));

          document.body.removeChild(testElementEl);
          document.body.removeChild(testElementDelayRenderEl);
        });

        test("it should append the template to the shadow root when the render method is called", done => {
          const testElementDelayRenderEl = document.createElement("test-element-delay-render");
          testElementDelayRenderEl.id = "test-element-delay-render";
          document.body.appendChild(testElementDelayRenderEl);

          flush(() => {
            const testElementDelayRender = document.querySelector("test-element-delay-render");
            const testElementDelayRenderShadowRoot = testElementDelayRender.shadowRoot;
            const divs = testElementDelayRenderShadowRoot.querySelectorAll("div");

            assert.lengthOf(divs, 3);

            [...divs].forEach((div, index) => {
              assert.equal(div.textContent, colors[index]);
            });

            document.body.removeChild(testElementDelayRenderEl);
            done();
          });
        });

        test("it should throw an error when the on attribute is manually added", () => {
          const spy = sinon.spy(console, "warn");

          // with an id

          const testElementEl1 = document.createElement("test-element");

          testElementEl1.id = "test-element";
          testElementEl1.setAttribute("on", "saturated");

          document.body.appendChild(testElementEl1);

          sinon.assert.calledWith(spy, `test-element[#test-element]: The "on" attribute is protected and should not be manually added to a component. The base class will manage this value for you on upgrade.`);

          // without an id

          const testElementEl2 = document.createElement("test-element");
          testElementEl2.setAttribute("on", "saturated");
          document.body.appendChild(testElementEl2);
          sinon.assert.calledWith(spy, `test-element: The "on" attribute is protected and should not be manually added to a component. The base class will manage this value for you on upgrade.`);
        });

        test("it should default to the provided --context variable in the component's stylesheet", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          flush(() => {
            assert.equal(testElement.getAttribute("on"), "dark");
          });
        });

        test("it should update the pfe-g-context attribute if style with --context is manually added after upgrade", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          setTimeout(function () {
            testElement.setAttribute("style", "color: pink; --context: light;");
          }, 200);

          flush(() => {
            assert.equal(testElement.getAttribute("pfe-g-context"), "light");
          });
        });

        test("it should favor pfe-g-context attribute over the --context variable", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          testElement.setAttribute("pfe-g-context", "saturated");
          testElement.setAttribute("style", "color: pink; --context: light;");

          flush(() => {
            assert.equal(testElement.getAttribute("on"), "saturated");
          });
        });

        test("it should update the on attribute if pfe-g-context is manually added after upgrade", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          setTimeout(function () {
            document.querySelector("#test-element").setAttribute("pfe-g-context", "light");
          }, 200);

          flush(() => {
            assert.equal(testElement.getAttribute("on"), "light");
          });
        });

        test("it should push down the context to children", () => {
          const testElement = document.createElement("test-element");
          const testChildElement = document.createElement("test-child-element");

          testElement.id = "test-element";
          testChildElement.id = "test-child-element";

          testElement.appendChild(testChildElement);
          document.body.appendChild(testElement);

          flush(() => {
            assert.equal(testChildElement.getAttribute("on"), "dark");
          });
        });

        test("it should push an attribute override context down to the children", () => {
          const testElement = document.createElement("test-element");
          const testChildElement = document.createElement("test-child-element");

          testElement.id = "test-element";
          testChildElement.id = "test-child-element";

          testElement.appendChild(testChildElement);
          document.body.appendChild(testElement);

          // Add the context information
          testElement.setAttribute("pfe-g-context", "light");

          flush(() => {
            assert.equal(testChildElement.getAttribute("on"), "light");
          });
        });

        test("it should push a variable override context down to the children", () => {
          const testElement = document.createElement("test-element");
          const testChildElement = document.createElement("test-child-element");

          testElement.id = "test-element";
          testChildElement.id = "test-child-element";

          testElement.appendChild(testChildElement);
          document.body.appendChild(testElement);

          // Add the context information
          testElement.setAttribute("style", "--context: light;");

          flush(() => {
            assert.equal(testChildElement.getAttribute("on"), "light");
          });
        });

        test("it should favor child's context if set via variable --context", () => {
          const testElement = document.createElement("test-element");
          const testChildElement = document.createElement("test-child-element");

          testElement.id = "test-element";
          testChildElement.id = "test-child-element";

          testElement.appendChild(testChildElement);
          document.body.appendChild(testElement);

          // Add the context information
          testChildElement.setAttribute("style", "--context: light;");

          flush(() => {
            assert.equal(testChildElement.getAttribute("on"), "light");
          });
        });

        test("it should favor child's context if set", () => {
          const testElement = document.createElement("test-element");
          const testChildElement = document.createElement("test-child-element");

          testElement.id = "test-element";
          testChildElement.id = "test-child-element";

          testElement.appendChild(testChildElement);
          document.body.appendChild(testElement);

          // Add the context information
          testChildElement.setAttribute("pfe-g-context", "light");

          flush(() => {
            assert.equal(testChildElement.getAttribute("on"), "light");
          });
        });

        // @TODO deprecate for 1.0
        test("it should update the pfe-g-context attribute if style with --context is manually added after upgrade", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          setTimeout(function () {
            testElement.setAttribute("style", "color: pink; --context: light;");
          }, 200);

          flush(() => {
            assert.equal(testElement.getAttribute("pfe-g-context"), "light");
            assert.equal(testElement.getAttribute("on"), "light");
          });
        });

        test("it should update the on and pfe-g-context attributes if pfe-theme is manually added after upgrade", () => {
          const testElement = document.createElement("test-element");

          testElement.id = "test-element";
          document.body.appendChild(testElement);

          setTimeout(function () {
            document.querySelector("#test-element").setAttribute("pfe-theme", "light");
          }, 200);

          flush(() => {
            assert.equal(testElement.getAttribute("on"), "light");
            assert.equal(testElement.getAttribute("pfe-g-context"), "light");
          });
        });
      });
    </script>
</body>

</html>
