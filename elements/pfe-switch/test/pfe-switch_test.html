<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="/components/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src="/components/web-component-tester/browser.js"></script>
    <script type="module" src="../dist/pfe-switch.js"></script>
  </head>
  <body style="padding: 3em 4em">

    <h2>With on and off messages</h2>
    <pfe-switch id="pfe-switch-1" pfe-message-on="Message when on" pfe-message-off="Message when off">
      <input type="checkbox" id="switch-with-label-1" name="switchExample1" checked>
      <label for="switch-with-label-1">
        Fallback label
      </label>
    </pfe-switch>

    <h2>With on messages</h2>
    <pfe-switch id="pfe-switch-2" pfe-message-on="Message when on">
      <input type="checkbox" id="switch-with-on-label-1" name="switchExample2-1" checked>
      <label for="switch-with-on-label-1">
        Fallback label
      </label>
    </pfe-switch>

    <h2>With off messages</h2>
    <pfe-switch id="pfe-switch-3" pfe-message-off="Message when off">
      <input type="checkbox" id="switch-with-off-label-1" name="switchExample2-3">
      <label for="switch-with-off-label-1">
        Fallback label
      </label>
    </pfe-switch>

    <h2>With no messages, only fallback</h2>
    <pfe-switch id="pfe-switch-4">
      <input type="checkbox" id="switch-with-fallback-label-1" name="switchExample2-4">
      <label for="switch-with-fallback-label-1">
        Fallback label
      </label>
    </pfe-switch>


    <h2 style="margin-top: 2em;">
      Hidden Labels
    </h2>
    <pfe-switch id="pfe-switch-5" pfe-hide-label="true">
      <input type="checkbox" id="switch-hidden-label-1" name="switchExample3" checked>
      <label for="switch-hidden-label-1">
        Hidden Label
      </label>
    </pfe-switch>

    <script>
      const elements = [...document.querySelectorAll("pfe-switch")];

      suite("<pfe-switch>", () => {
        test("it should upgrade", () => {
          assert.instanceOf(
            document.querySelector("pfe-switch"),
            customElements.get("pfe-switch"),
            "pfe-switch should be an instance of pfeSwitch"
          );
        });

        // Write tests for each attribute
        test("it should have pfe-checked attribute when the checkbox is clicked", () => {
          const pfeSwitch = document.getElementById('pfe-switch-1');
          const pfeSwitchInput = document.getElementById('switch-with-label-1');

          assert.isTrue(pfeSwitch.hasAttribute('pfe-checked'));
          pfeSwitchInput.click();
          assert.isNotTrue(pfeSwitch.hasAttribute('pfe-checked'));

        });

        /**
         * Tests for different on/off/fallback label states
         */
        test("label text should change to message-on and message-off", () => {
          const pfeSwitch = document.getElementById('pfe-switch-1');
          const pfeSwitchInput = document.getElementById('switch-with-label-1');
          const pfeSwitchLabel = document.querySelector('[for="switch-with-label-1"]');

          // Making sure the checkbox state is what we think it is
          if (!pfeSwitch.hasAttribute('pfe-checked')) {
            pfeSwitchInput.click();
          }
          assert.isTrue(pfeSwitchLabel.textContent.trim() === pfeSwitch.getAttribute('pfe-message-on').trim());
          pfeSwitchInput.click();
          assert.isTrue(pfeSwitchLabel.textContent.trim() === pfeSwitch.getAttribute('pfe-message-off').trim());

        });

        test("label text should change to message-on and 'Fallback label' if there's no message-off", () => {
          const pfeSwitch = document.getElementById('pfe-switch-2');
          const pfeSwitchInput = document.getElementById('switch-with-on-label-1');
          const pfeSwitchLabel = document.querySelector('[for="switch-with-on-label-1"]');

          // Making sure the checkbox state is what we think it is
          if (!pfeSwitch.hasAttribute('pfe-checked')) {
            pfeSwitchInput.click();
          }
          assert.isTrue(pfeSwitchLabel.textContent.trim() === pfeSwitch.getAttribute('pfe-message-on').trim());
          pfeSwitchInput.click();
          assert.isTrue(pfeSwitchLabel.textContent.trim() === 'Fallback label');

        });

        test("label text should change to 'Fallback label' and message-off if there's no message-on", () => {
          const pfeSwitch = document.getElementById('pfe-switch-3');
          const pfeSwitchInput = document.getElementById('switch-with-off-label-1');
          const pfeSwitchLabel = document.querySelector('[for="switch-with-off-label-1"]');

          // Making sure the checkbox state is what we think it is
          if (!pfeSwitch.hasAttribute('pfe-checked')) {
            pfeSwitchInput.click();
          }
          assert.isTrue(pfeSwitchLabel.textContent.trim() === 'Fallback label');
          pfeSwitchInput.click();
          assert.isTrue(pfeSwitchLabel.textContent.trim() === pfeSwitch.getAttribute('pfe-message-off').trim());

        });

        test("label text should remain 'Fallback label' if there's no message-off or message-on", () => {
          const pfeSwitch = document.getElementById('pfe-switch-4');
          const pfeSwitchInput = document.getElementById('switch-with-fallback-label-1');
          const pfeSwitchLabel = document.querySelector('[for="switch-with-fallback-label-1"]');

          // Making sure the checkbox state is what we think it is
          if (!pfeSwitch.hasAttribute('pfe-checked')) {
            pfeSwitchInput.click();
          }
          assert.isTrue(pfeSwitchLabel.textContent.trim() === 'Fallback label');
          pfeSwitchInput.click();
          assert.isTrue(pfeSwitchLabel.textContent.trim() === 'Fallback label');

        });

        /**
         * Test disabled state
         */
        test("can't interact when disabled, can interact when enabled again", () => {
          const pfeSwitch = document.getElementById('pfe-switch-1');
          const pfeSwitchInput = document.getElementById('switch-with-label-1');
          const pfeSwitchLabel = document.querySelector('[for="switch-with-label-1"]');

          // Making sure the checkbox state is what we think it is
          if (!pfeSwitch.hasAttribute('pfe-checked')) {
            pfeSwitchInput.click();
          }

          // When disabled state doesn't change on click
          pfeSwitchInput.setAttribute('disabled', 'disabled');
          assert.isTrue(pfeSwitch.hasAttribute('pfe-checked'));
          pfeSwitchInput.click();
          assert.isTrue(pfeSwitch.hasAttribute('pfe-checked'));

          // When NOT disabled state changes on click
          pfeSwitchInput.removeAttribute('disabled');
          assert.isTrue(pfeSwitch.hasAttribute('pfe-checked'));
          pfeSwitchInput.click();
          assert.isNotTrue(pfeSwitch.hasAttribute('pfe-checked'));

        });

        /**
         * Test to make sure errors are working
         */
        const spy = sinon.spy(console, 'error');
        test("if the input doesn't have a label with a corresponding for attribute, should get an error", () => {

          document.body.innerHTML += `
            <pfe-switch id="fubar-pfe-switch-1">
              <input type="checkbox" id="fubar-pfe-switch-input-1">
              <label for="bad-id">This will fail!</label>
            </pfe-switch>`;

          sinon.assert.calledWith(spy, 'pfe-switch: Label element does not have a corresponding checkbox, label\'s for attribute is bad-id');
        });

        test("No label text will cause an error", () => {
          document.body.innerHTML += `
            <pfe-switch id="fubar-pfe-switch-2">
              <input type="checkbox" id="fubar-pfe-switch-input-2">
              <label for="fubar-pfe-switch-input-2"></label>
            </pfe-switch>`;

          sinon.assert.calledWith(spy, 'pfe-switch: Label text not found. Form elements require meaningful label text for accessibility. The label can be visually hidden, but must exist.');
        });

        test("No label will cause an error", () => {

          document.body.innerHTML += `
            <pfe-switch id="fubar-pfe-switch-3">
              <input type="checkbox" id="fubar-pfe-switch-input-3">
            </pfe-switch>`;

          sinon.assert.calledWith(spy, 'pfe-switch: Label element with text and for element required for pfe-switch to function');
        });

      });
    </script>
  </body>
</html>
